# 機能詳細仕様書

**作成日**: 2026年2月28日  
**最終更新日**: 2026年2月28日（リファクタリング反映）  
**対象システム**: シフト管理アプリケーション（manus-shift-app）  
**技術スタック**: React 19 / TypeScript / Vite / Supabase / TailwindCSS / shadcn/ui / DnD Kit

---

## 1. システム全体構成

### 1.1. アーキテクチャ概要

本システムは、フロントエンド（React SPA）とバックエンド（Supabase + APIサーバー）で構成されます。

```
[ブラウザ]
    │
    ├── React SPA (Vite + TypeScript)
    │       └── Supabase JS Client → Supabase (PostgreSQL)
    │
    └── /api/generate-shifts → APIサーバー（シフト自動生成）
```

### 1.2. エントリーポイントとルーティング

アプリケーションのエントリーポイントは `src/main.tsx` → `src/App.tsx` です。`src/App.tsx` で定義されたルーティングは `ProtectedRoute` コンポーネントで権限制御されています。

> **注意**: `src/pages/App.tsx` にも別のルーティング定義が存在しますが、実際に使用されているのは `src/App.tsx` です。

| パス | ページ | 必要権限レベル |
|---|---|---|
| `/` | ホーム（Index） | 1（一般ユーザー） |
| `/shift-schedule` | シフト管理・閲覧 | 1 |
| `/profile` | プロフィール | 1 |
| `/mobile-shift-view` | モバイルシフト表示 | 1 |
| `/overtime-registration` | 残業登録 | 2（管理者） |
| `/shift-generator` | シフト自動生成 | 2 |
| `/vacation-management` | 休暇管理 | 2 |
| `/employees` | 従業員管理 | 2 |
| `/business-rules` | 業務ルール管理（旧） | 2 |
| `/unified-rules` | 統合ルール管理 | 2 |
| `/master-data` | マスタデータ管理 | 2 |
| `/reports` | レポート | 2 |
| `/users` | ユーザー管理 | 2 |
| `/user-registration` | ユーザー登録 | 3（スーパー管理者） |

---

## 2. 認証・認可機能

### 2.1. ログイン（`Login.tsx`）

Supabase Auth を利用したユーザーIDとパスワードによる認証を実装しています。

- ユーザーIDとパスワードを入力してログイン
- 認証成功後、`employees` テーブルの `is_admin` フラグを参照して権限レベルを決定
- セッション情報はブラウザのローカルストレージに保持

### 2.2. 権限制御（`ProtectedRoute.tsx`）

`requiredRole` パラメータで各ページへのアクセス権限を制御します。権限不足の場合はホーム画面にリダイレクトされます。

---

## 3. シフト自動生成機能（`ShiftGenerator.tsx`）

### 3.1. 概要

指定された期間と営業所に基づき、従業員と業務の最適な組み合わせを自動で計算してシフト案を作成する、本システムのコア機能です。生成ロジックはバックエンドの `/api/generate-shifts` APIサーバーに委譲されています。

### 3.2. シフト生成フロー

```
1. 拠点・期間選択
2. 「シフトを生成」ボタンクリック
3. 既存シフトの確認（重複チェック）
4. /api/generate-shifts へのPOSTリクエスト
5. 生成結果をShiftResult[]として受信
6. マトリクス形式で結果表示
7. インタラクティブ編集（ドラッグ&ドロップ、右クリック削除）
8. 「シフトを保存」で shifts テーブルに保存
```

### 3.3. 生成条件の設定

| 設定項目 | 説明 |
|---|---|
| 拠点選択 | 対象営業所をドロップダウンで選択 |
| 開始日 | シフト生成の開始日 |
| 終了日 | シフト生成の終了日 |

### 3.4. 結果表示（マトリクス）

生成結果は業務（行）× 日付（列）のマトリクス形式で表示されます。

- **セル内容**: アサインされた従業員名バッジ（ドラッグ可能）
- **空きセル**: 未アサインの状態（ドロップ可能）
- **ペア業務**: 2名が同時にアサインされる業務は特別な表示
- **最下行**: 「非出勤者（希望休）」行 — 各日付で休暇を取得している従業員をオレンジチップで表示（休暇データが存在する場合のみ）

### 3.5. 未アサイン従業員パネル（フローティング）

画面右端に常時固定表示されるパネルで、未アサインの従業員を管理します。

| 機能 | 説明 |
|---|---|
| 日付グループ表示 | 未アサイン従業員を日付ごとにグループ化して表示 |
| 折りたたみ | 日付グループを展開・折りたたみ可能 |
| 検索 | 従業員名でリアルタイム絞り込み |
| パネル開閉 | ►/◄ ボタンでパネルを非表示にしてマトリクスを全幅表示 |
| ドラッグ | 従業員バッジをドラッグして空きセルにドロップ |

### 3.6. インタラクティブ編集

**ドラッグ&ドロップ（DnD Kit使用）**:
- 未アサインパネルの従業員バッジ → 空きセルにドロップ: アサイン
- アサイン済みセルの従業員バッジ → 別のセルにドロップ: 移動
- アサイン済みセルの従業員バッジ → 未アサインパネルにドロップ: アサイン解除

**右クリック削除（カスタムコンテキストメニュー）**:
- アサイン済みの従業員バッジを右クリック → 「削除」メニュー表示
- 削除するとセルが空きになり、従業員が未アサインパネルに戻る

### 3.7. シフト保存

変更がある場合（`hasChanges = true`）に「シフトを保存」ボタンが有効化されます。

- 保存処理: 既存の同日付・同営業所のシフトを削除後、新しいシフトを `shifts` テーブルに一括 INSERT
- `multi_day_set_id` / `multi_day_info` も保持して保存

---

## 4. シフト管理・閲覧機能（`ShiftSchedule.tsx`）

### 4.1. 概要

確定済みのシフトを閲覧・編集・管理する機能です。2,481行の最大規模のコンポーネントで、多彩な表示・編集機能を持ちます。

### 4.2. 表示モード

| モード | 説明 |
|---|---|
| 日次ビュー | 特定の1日のシフトを表示 |
| 期間ビュー | 指定した期間（複数日）のシフトを表示 |
| 従業員軸 | 行=従業員、列=業務/日付 |
| 業務軸 | 行=業務、列=従業員/日付 |

### 4.3. 編集機能

| 機能 | 操作方法 |
|---|---|
| セル選択 | クリックで選択（複数選択可） |
| 一括削除 | `Delete` キーで選択シフトを削除 |
| 従業員アサイン | 空きセルをクリック → 候補従業員ポップアップから選択 |
| スポット業務追加 | 特定の従業員・日付に臨時業務を追加 |
| シフトコピー | 指定した期間のシフトを別の期間にコピー |

### 4.4. ルールチェック

`ruleChecker.ts` を使用して、現在のシフトが `unified_shift_rules` に違反していないかチェックします。

チェック項目:
- **時間重複チェック**: 同一従業員が同日に重複する時間帯の業務に割り当てられていないか
- **休憩時間チェック**: 連続勤務の間に十分な休憩時間が確保されているか
- **連続勤務日数チェック**: 法定・規定の連続勤務上限を超えていないか
- **分割休憩チェック**: 分割休憩のルールに違反していないか
- **点呼担当チェック**: 点呼担当資格を持つ従業員が適切に配置されているか

### 4.5. Excelエクスポート

表示しているシフトを Excel 形式（`.xlsx`）でダウンロードできます。

---

## 5. 従業員管理機能（`EmployeeManagement.tsx`）

### 5.1. 概要

従業員の登録・編集・削除を行う機能です。

### 5.2. 主要機能

| 機能 | 説明 |
|---|---|
| 従業員一覧 | 全従業員を一覧表示（営業所・班でフィルタ可） |
| 新規登録 | 従業員ID、氏名、営業所、班、点呼担当などを登録 |
| 編集 | 既存従業員情報の変更 |
| 削除 | 従業員の削除 |
| CSVインポート | CSV ファイルから従業員を一括登録 |
| Excel インポート | Excel ファイルから従業員を一括登録 |
| 表示順変更 | ドラッグ&ドロップで表示順を変更 |

---

## 6. マスタデータ管理機能（`MasterDataManagement.tsx`）

### 6.1. 概要

シフト生成に必要な業務マスタデータを管理する機能です。3つのタブで構成されています。

### 6.2. タブ構成

**業務グループタブ**:
- 業務をまとめるグループの作成・編集・削除
- グループ名、説明、所属業務の管理

**業務マスタタブ**:
- 業務の詳細定義（業務名、営業所、スキル要件、開始/終了時間、各種手当フラグ）
- ペア業務の設定（2名同時アサインが必要な業務）
- CSV/Excel からの一括インポート

**スポット業務タブ**:
- 臨時で発生するスポット業務の管理
- 通常の業務マスタとは別に管理

---

## 7. 統合シフトルール管理機能（`UnifiedRuleManagement.tsx`）

### 7.1. 概要

シフト自動生成のロジックを制御するルールを一元管理する機能です。旧来の `BusinessRuleManagement` を置き換える、より汎用性の高いシステムです。

### 7.2. ルール種別

| ルール種別 | 説明 |
|---|---|
| `constraint` | 制約ルール（違反すると生成不可） |
| `filter` | フィルタリングルール（候補者の絞り込み） |
| `assignment` | 割り当てルール（アサインの優先順位） |
| `validation` | 検証ルール（生成後の妥当性チェック） |
| `optimization` | 最適化ルール（より良いシフトへの改善） |

### 7.3. 強制レベル

| 強制レベル | 説明 |
|---|---|
| `mandatory` | 必須（違反した場合は生成失敗） |
| `recommended` | 推奨（違反しても警告のみ） |
| `optional` | 任意（参考情報として表示） |

### 7.4. 主要機能

- ルール一覧表示（種別・営業所・キーワードでフィルタ）
- ルールの作成・編集・削除
- `rule_config` を JSON エディタで直接編集
- ルールの有効/無効切り替え
- 優先度の設定（0〜10）

---

## 8. 休暇管理機能（`VacationManagement.tsx`）

### 8.1. 概要

従業員の休暇（公休・私用・病欠など）を登録・管理する機能です。登録された休暇はシフト自動生成時に参照されます。

### 8.2. 主要機能

| 機能 | 説明 |
|---|---|
| 休暇登録 | 従業員、日付、休暇種別、理由を選択して登録 |
| 休暇一覧 | 登録済み休暇の一覧表示（日付・従業員でフィルタ） |
| 編集・削除 | 登録済み休暇の変更・削除 |
| シフト連携 | 登録された休暇はシフト生成時に除外対象となり、マトリクスの休暇行に表示 |

### 8.3. 休暇種別

`公休` / `私用` / `病欠` / `忌引` / `その他`

> **注意**: 「希望休」は休暇種別ではなく、シフト生成時に非出勤者行にドロップした際の理由文字列（`VACATION_REASON_REQUESTED`）として使用されます。

---

## 9. レポート機能（`Reports.tsx`）

### 9.1. 概要

シフトデータを集計・分析してレポートを生成する機能です。

### 9.2. 主要機能

- 期間・営業所を指定してレポート生成
- 従業員別勤務時間集計
- 業務別アサイン回数集計
- Excel 形式でのエクスポート

---

## 10. 残業登録機能（`OvertimeRegistration.tsx`）

### 10.1. 概要

従業員の残業時間を登録・管理する機能です。

### 10.2. 主要機能

- 残業の登録（従業員、日付、残業時間、理由）
- 残業一覧の表示・編集・削除

---

## 11. モバイルシフト表示（`MobileShiftView.tsx`）

### 11.1. 概要

スマートフォン向けに最適化されたシフト閲覧画面です。

### 11.2. 主要機能

- 自分のシフトを日付別に表示
- 当日・翌日のシフトを見やすく表示
- 読み取り専用（編集機能なし）

---

## 12. 定数管理（`src/constants/index.ts`）

アプリケーション全体で使用する定数を一元管理するモジュールです。各コンポーネントはハードコードされた文字列リテラルの代わりに、このファイルからインポートして使用します。

| 定数名 | 型 | 値 | 用途 |
|---|---|---|---|
| `OFFICES` | `readonly ['川越', '東京', '川口']` | 営業所3拠点 | 拠点選択ドロップダウン、フィルタ |
| `OFFICES_WITH_HQ` | `readonly ['川越', '東京', '川口', '本社']` | 本社含む全拠点 | 本社を含むフィルタ |
| `OFFICES_WITH_ALL` | `readonly ['全拠点', ...]` | 「全拠点」付きリスト | フィルタ用 |
| `TOKYO_TEAMS` | `readonly ['Galaxy', 'Aube', '無し']` | 東京班 | 従業員登録・編集 |
| `VACATION_TYPES` | `readonly ['公休', '私用', '病欠', '忌引', 'その他']` | 休暇種別 | 休暇管理 |
| `VACATION_REASON_REQUESTED` | `'希望休'` | 希望休理由 | シフト生成時 |
| `EMPLOYMENT_TYPES` | `readonly ['full-time', 'part-time', 'contract']` | 雇用形態 | 従業員管理 |

---

## 13. 主要ユーティリティ・ライブラリ

| ファイル | 役割 |
|---|---|
| `lib/supabase.ts` | Supabase クライアントの初期化 |
| `utils/auth.ts` | 認証関連ユーティリティ |
| `utils/ruleChecker.ts` | シフトルール違反チェックロジック |
| `utils/vacationManager.ts` | 休暇データの取得・管理 |
| `utils/businessMasterLoader.ts` | 業務マスタデータのロード |
| `utils/businessGroupManager.ts` | 業務グループの管理 |
| `utils/UnifiedRuleAdapter.ts` | 統合ルールのDB↔型変換アダプター |
| `utils/UnifiedRuleManager.ts` | 統合ルールの評価エンジン（一部未実装） |
| `utils/excelLoader.ts` | Excel ファイルの読み込み |
| `utils/correctExcelLoader.ts` | Excel データの補正付き読み込み |
| `utils/excelDataLoader.ts` | Excel データの汎用ローダー |
| `utils/employeeExcelLoader.ts` | 従業員 Excel インポート |
| `utils/csvLoader.ts` | CSV ファイルの読み込み |
| `utils/timeFormatter.ts` | 時刻フォーマットユーティリティ |
| `utils/employeeLoader.ts` | 従業員データのロード |
| `utils/skillMatrixLoader.ts` | スキルマトリクスデータのロード |
| `utils/masterDataLoader.ts` | マスタデータの汎用ローダー |
| `utils/excludedEmployeesManager.ts` | 除外従業員の管理 |
| `utils/incompatiblePairsManager.ts` | 相性不可ペアの管理 |
| `utils/splitRestValidator.ts` | 分割休憩のバリデーション |
| `utils/emptyTimeSlots.ts` | 空き時間枠の計算 |
| `utils/shiftCopy.ts` | シフトコピーロジック |
| `utils/databaseSetup.ts` | データベース初期設定 |
| `utils/supabaseAdmin.ts` | Supabase 管理者クライアント |
| `utils/supabaseClient.ts` | Supabase クライアント（汎用） |

---

## 14. 主要コンポーネント一覧

| コンポーネント | 役割 |
|---|---|
| `AddEmployeeModal.tsx` | 従業員新規登録モーダル |
| `EditEmployeeModal.tsx` | 従業員編集モーダル |
| `EmployeeForm.tsx` | 従業員フォーム共通コンポーネント |
| `EmployeeSkillModal.tsx` | 従業員スキル設定モーダル |
| `AddBusinessGroupModal.tsx` | 業務グループ追加モーダル |
| `EditBusinessGroupModal.tsx` | 業務グループ編集モーダル |
| `DeleteBusinessGroupModal.tsx` | 業務グループ削除確認モーダル |
| `AssignEmployeeDialog.tsx` | 従業員アサインダイアログ |
| `AddSpotBusinessDialog.tsx` | スポット業務追加ダイアログ |
| `SpotBusinessMasterManagement.tsx` | スポット業務マスタ管理 |
| `DeleteShiftsModal.tsx` | シフト削除確認モーダル |
| `ShiftCopyDialog.tsx` | シフトコピーダイアログ |
| `DraggableShiftCell.tsx` | ドラッグ可能なシフトセル |
| `CSVUploader.tsx` | CSV アップロードコンポーネント |
| `ProtectedRoute.tsx` | 権限チェック付きルートガード |
| `SkillManager.tsx` | スキル管理コンポーネント |
| `AddSkillAssignmentModal.tsx` | スキル割り当て追加モーダル |
| `EditSkillAssignmentModal.tsx` | スキル割り当て編集モーダル |
| `ExcludedEmployeesManagement.tsx` | 除外従業員管理 |
| `IncompatiblePairsManagement.tsx` | 相性不可ペア管理 |
| `EditRuleModal.tsx` | ルール編集モーダル |

---

## 15. 依存パッケージ

### 15.1. 主要 dependencies

| パッケージ | バージョン | 用途 |
|---|---|---|
| `react` / `react-dom` | ^19.1.1 | UIフレームワーク |
| `react-router-dom` | ^6.26.2 | ルーティング |
| `@supabase/supabase-js` | ^2.88.0 | Supabase クライアント |
| `@tanstack/react-query` | ^5.56.2 | データ取得・キャッシュ（将来的な活用予定） |
| `@dnd-kit/core` / `@dnd-kit/utilities` | ^6.3.1 / ^3.2.2 | ドラッグ&ドロップ |
| `@radix-ui/*` | 各種 | shadcn/ui の基盤コンポーネント |
| `xlsx` | ^0.18.5 | Excel ファイル読み書き |
| `papaparse` | ^5.5.3 | CSV パーサー |
| `date-fns` | ^3.6.0 | 日付操作 |
| `recharts` | ^2.12.7 | チャート・グラフ |
| `sonner` | ^1.5.0 | トースト通知 |
| `lucide-react` | ^0.462.0 | アイコン |

### 15.2. 主要 devDependencies

| パッケージ | バージョン | 用途 |
|---|---|---|
| `vite` | ^5.4.1 | ビルドツール |
| `typescript` | ^5.5.3 | TypeScript コンパイラ |
| `tailwindcss` | ^3.4.11 | CSSフレームワーク |
| `eslint` | ^9.9.0 | コード品質チェック |
| `@vitejs/plugin-react-swc` | ^3.5.0 | React SWC プラグイン |
